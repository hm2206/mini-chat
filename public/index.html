<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <title>Mini Chat</title>
</head>
<body class="container">
    
    <h1 class="mt-5">
        Mini Chat 
        <span id="status" class="btn btn-sm btn-outline-danger">Off</span>
    </h1>
    
    <hr>

    <form id="myForm">
        <div class="row">
            <div class="col-8">
                <input type="text" id="txtMessage" placeholder="Mensaje" class="form-control">
            </div>

            <div class="col-4">
                <button class="btn btn-primary">
                    Enviar
                </button>
            </div>
        </div>
    </form>


    <div class="row">
        <div class="col">
            <ul id="listMessage" class="mt-2"></ul>
        </div>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.2/socket.io.js" integrity="sha512-YybopSVjZU0fe8TY4YDuQbP5bhwpGBE/T6eBUEZ0usM72IWBfWrgVI13qfX4V2A/W7Hdqnm7PIOYOwP9YHnICw==" crossorigin="anonymous"></script>

    <script>

        const list_status = {
            on: {
                className: "btn btn-sm btn-outline-success",
                text: "On"
            },
            off: {
                className: "btn btn-sm btn-outline-danger",
                text: "Off"
            },
        }

        // link
        const path = "/mini-chat/socket.io";
        const link = "https://sis.unia.edu.pe";

        // socket client
        const socket = io(link, { path });
        console.log(`socket escuchando en: ${link}/${path}`);

        // DOM
        const status = document.getElementById('status');
        const form = document.getElementById('myForm');
        const message = document.getElementById('txtMessage');
        const list = document.getElementById('listMessage');

        // escuchar estado del cliente
        const handleStatus = (current = 'on') => {
            let current_status = list_status[current];
            status.innerText = current_status.text;
            status.className = current_status.className;
        }

        // pintar mensaje
        const drawMessage = (msg) => {
            let li = document.createElement('li');
            li.innerText = msg;
            list.appendChild(li);
        }

        // connect initial
        socket.on('init', (data) => {
            handleStatus('on');
        });

        // enviar mensaje
        form.addEventListener('submit', (evt) => {
            evt.preventDefault();
            socket.emit('client@message', {
                success: true,
                message: message.value || ""
            });
            // clear input
            message.value = "";
        });

        // recibir mensaje
        socket.on('server@message', (data) => drawMessage(data.message));

    </script>

</body>
</html>